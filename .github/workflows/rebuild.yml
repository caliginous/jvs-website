name: Rebuild JVS Website (Legacy - Use Specific Workflows)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      user:
        description: 'User who triggered the rebuild'
        required: true
        default: 'webhook'
      reason:
        description: 'Reason for rebuild'
        required: false
        default: 'Content release'
  repository_dispatch:
    types: [wordpress_update]

jobs:
  dispatch-rebuild:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    
    steps:
    - name: Trigger Staging Rebuild
      if: github.event.inputs.environment == 'staging' || github.event_name == 'repository_dispatch'
      uses: actions/github-script@v7
      with:
        script: |
          // Handle both workflow_dispatch and repository_dispatch events
          const isWebhook = context.eventName === 'repository_dispatch';
          const user = isWebhook ? 'webhook' : (context.payload.inputs?.user || 'manual');
          const reason = isWebhook ? 'WordPress content update' : (context.payload.inputs?.reason || 'Manual trigger');
          
          console.log(`Triggering staging rebuild - User: ${user}, Reason: ${reason}, Event: ${context.eventName}`);
          
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'rebuild-staging.yml',
            ref: 'main',
            inputs: {
              user: user,
              reason: reason
            }
          });
          
    - name: Trigger Production Rebuild
      if: github.event.inputs.environment == 'production'
      uses: actions/github-script@v7
      with:
        script: |
          const user = context.payload.inputs?.user || 'manual';
          const reason = context.payload.inputs?.reason || 'Production deployment';
          
          console.log(`Triggering production rebuild - User: ${user}, Reason: ${reason}`);
          
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'rebuild-production.yml',
            ref: 'main',
            inputs: {
              user: user,
              reason: reason,
              run_tests: 'true'
            }
          });
          
    - name: Notify dispatch
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "ğŸš€ Triggered ${{ github.event.inputs.environment }} rebuild"
          echo "ğŸ‘¤ User: ${{ github.event.inputs.user }}"
          echo "ğŸ“ Reason: ${{ github.event.inputs.reason }}"
        else
          echo "ğŸš€ Triggered staging rebuild from WordPress webhook"
          echo "ğŸ‘¤ User: webhook"
          echo "ğŸ“ Reason: WordPress content update"
        fi 